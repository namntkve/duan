
// /  const SUPABASE_URL = 'https://jhybbyzpgyfxtfpnuhqt.supabase.co';
///    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoeWJieXpwZ3lmeHRmcG51aHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTg2MTgsImV4cCI6MjA2OTU5NDYxOH0.d0jrlFshaX-y_HSuVL_LOo0JsPvD1qqm4ceK1styUaQ';
///    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Manager • Supabase • Bootstrap</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    html, body { height:100%; background:#f8f9fa; }
    .sidebar { width:280px; position:sticky; top:0; height:100vh; background:#fff; border-right:1px solid #e9ecef; }
    .sidebar .nav-link { border-radius:.5rem; color:#334155; }
    .sidebar .nav-link.active, .sidebar .nav-link:hover { background:#e7f1ff; color:#0d6efd; }
    .content-wrap { margin-left:0; }
    @media(min-width:992px){ .content-wrap{margin-left:280px;} }
    .card-shadow{box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid #eef2f7;border-radius:1rem;}
    .suggestions{position:absolute;z-index:1050;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;max-height:260px;overflow-y:auto;width:100%;box-shadow:0 10px 22px rgba(0,0,0,.08);}
    .suggestion-item{padding:.5rem .75rem;cursor:pointer;}
    .suggestion-item:hover{background:#f5f7fb;}
    .section-anchor{scroll-margin-top:80px;}
    .auth-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.55);backdrop-filter:blur(2px);z-index:3000;}
    .auth-card{width:420px;border-radius:1rem;box-shadow:0 20px 40px rgba(0,0,0,.2);}
  </style>
</head>
<body>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay d-none">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập VSEC PM</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email có trong bảng <code>user_profiles</code> và <code>active = true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập với Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar p-3">
    <a class="d-flex align-items-center mb-3 text-decoration-none">
      <span class="fs-5 fw-bold"><i class="bi bi-kanban me-2"></i>VSEC PM</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>Customers</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="tasks"><i class="bi bi-list-check me-2"></i>Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="opportunities"><i class="bi bi-bullseye me-2"></i>Opportunities</a></li>
      <li class="nav-item"><a class="nav-link" data-page="quotes"><i class="bi bi-receipt me-2"></i>Quotes</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item" id="navUsers"><a class="nav-link" data-page="users"><i class="bi bi-person-gear me-2"></i>Users</a></li>
    </ul>
    <hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name=VSEC&background=0D6EFD&color=fff" width="32" height="32" class="rounded-circle me-2">
        <strong id="currentEmail">guest@local</strong>
      </a>
      <ul class="dropdown-menu shadow">
        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
      </ul>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content-wrap">
    <div class="container-fluid py-4">

      <!-- Dashboard -->
      <section id="page-dashboard" class="section-anchor">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        </div>
        <div class="row g-4">
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Customers</h6><h2 class="fw-bold mb-0" id="kpiCustomers">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Projects</h6><h2 class="fw-bold mb-0" id="kpiProjects">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Tasks</h6><h2 class="fw-bold mb-0" id="kpiTasks">0</h2></div></div></div>
          <div class="col-12 col-sm-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Opportunities</h6><h2 class="fw-bold mb-0" id="kpiOpportunities">0</h2></div></div></div>
        </div>
      </section>

      <!-- Customers -->
      <section id="page-customers" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Customers</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddCustomer"><i class="bi bi-plus-lg me-1"></i>Thêm khách hàng</button></div>
        </div>
        <div id="customerFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>Tax</th><th>Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Projects -->
      <section id="page-projects" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div>
        </div>
        <div id="projectFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Customer</th><th>Start</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Tasks -->
      <section id="page-tasks" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-list-check me-2"></i>Tasks</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddTask"><i class="bi bi-plus-lg me-1"></i>Thêm nhiệm vụ</button></div>
        </div>
        <div id="taskFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr>
              <th>Title</th><th>Project</th><th>Assignee</th><th>Status</th><th>Priority</th><th>Start</th><th>Due</th><th>Planned</th><th>Actual</th><th>Actions</th>
            </tr></thead>
            <tbody id="taskTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Opportunities -->
      <section id="page-opportunities" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-bullseye me-2"></i>Opportunities</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddOpportunity"><i class="bi bi-plus-lg me-1"></i>Thêm cơ hội</button></div>
        </div>
        <div id="oppFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Customer</th><th>Value</th><th>Stage</th><th>Actions</th></tr></thead>
            <tbody id="oppTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Quotes -->
      <section id="page-quotes" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-receipt me-2"></i>Quotes</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddQuote"><i class="bi bi-plus-lg me-1"></i>Thêm báo giá</button></div>
        </div>
        <div id="quoteFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Customer</th><th>Project</th><th>Description</th><th>Amount</th><th>Status</th><th>Sent</th><th>PDF</th><th>Actions</th></tr></thead>
            <tbody id="quoteTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Contracts -->
      <section id="page-contracts" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Contracts</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddContract"><i class="bi bi-plus-lg me-1"></i>Thêm hợp đồng</button></div>
        </div>
        <div id="contractFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Project</th><th>Customer</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- Users -->
      <section id="page-users" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Thêm user</button></div>
        </div>
        <div id="userFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>Email</th><th>Name</th><th>Role</th><th>Active</th><th>Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div></div>
      </section>

    </div>
  </main>

  <!-- SCRIPT -->
  <script>
    // 0) CONFIG
      const SUPABASE_URL = 'https://jhybbyzpgyfxtfpnuhqt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoeWJieXpwZ3lmeHRmcG51aHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTg2MTgsImV4cCI6MjA2OTU5NDYxOH0.d0jrlFshaX-y_HSuVL_LOo0JsPvD1qqm4ceK1styUaQ';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) STATE
    let currentUser = { email:null, role:'user' };
    let customers = [], projects = [], tasks = [], opportunities = [], quotes = [], contracts = [], users = [];

    // Helpers
    function money(n){ return (n||0).toLocaleString('vi-VN') + ' đ'; }
    function pad(n,w){ return (n+'').padStart(w,'0'); }
    function getWeekNumber(d=new Date()){
      const date = new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
      const dayNum = date.getUTCDay()||7;
      date.setUTCDate(date.getUTCDate()+4-dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil((((date-yearStart)/86400000)+1)/7);
    }

    // 2) LOAD DATA
    async function loadAll(){
      const rs = await Promise.all([
        sb.from('customers').select('*').order('id'),
        sb.from('projects').select('*').order('project_id'),
        sb.from('tasks').select('*').order('created_at'),
        sb.from('opportunities').select('*').order('opportunity_id'),
        sb.from('quotes').select('*').order('quotes_id'),
        sb.from('contracts').select('*').order('contract_id'),
        sb.from('user_profiles').select('*')
      ]);
      customers     = rs[0].data || [];
      projects      = rs[1].data || [];
      tasks         = rs[2].data || [];
      opportunities = rs[3].data || [];
      quotes        = rs[4].data || [];
      contracts     = rs[5].data || [];
      users         = rs[6].data || [];
    }

    // 3) RENDER
    function setKPIs(){
      document.getElementById('kpiCustomers').textContent = customers.length;
      document.getElementById('kpiProjects').textContent  = projects.length;
      document.getElementById('kpiTasks').textContent     = tasks.length;
      document.getElementById('kpiOpportunities').textContent = opportunities.length;
    }

    function renderCustomers(){
      const tbody = document.getElementById('customerTbody');
      const elevated = currentUser.role==='admin';
      let list = elevated ? customers : customers.filter(c=>c.created_by===currentUser.email);
      tbody.innerHTML = list.map(c=>`
        <tr>
          <td>${c.id}</td>
          <td>${c.name}</td>
          <td>${c.contact_person||''}</td>
          <td>${c.phone||''}</td>
          <td>${c.email||''}</td>
          <td>${c.tax_code||''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCustomerForm('${c.id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer('${c.id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    function renderProjects(){
      const tbody = document.getElementById('projectTbody');
      tbody.innerHTML = projects.map(p=>{
        const c = customers.find(x=>x.id===p.customer_id);
        return `<tr>
          <td>${p.project_id}</td>
          <td>${p.project_name}</td>
          <td>${c?c.name:p.customer_id}</td>
          <td>${p.start_date||''}</td>
          <td>${p.end_date||''}</td>
          <td>${p.status||''}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openProjectForm('${p.project_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProject('${p.project_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderTasks(){
      const tbody = document.getElementById('taskTbody');
      tbody.innerHTML = tasks.map(t=>{
        const p = projects.find(x=>x.project_id===t.project_id);
        const u = users.find(x=>x.email===t.assigned_to);
        return `<tr>
          <td>${t.title}</td>
          <td>${p? p.project_name : t.project_id}</td>
          <td>${u? u.name : ''}</td>
          <td>${t.status}</td>
          <td>${t.priority||''}</td>
          <td>${t.start_date||''}</td>
          <td>${t.due_date||''}</td>
          <td>${t.planned_hours||0}</td>
          <td>${t.actual_hours||0}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openTaskForm('${t.task_id}')"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${t.task_id}')"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      }).join('');
    }

    // (Tương tự renderOpp, renderQuotes, renderContracts, renderUsers…)

    function renderAll(){
      setKPIs();
      renderCustomers();
      renderProjects();
      renderTasks();
      renderOpportunities();
      renderQuotes();
      renderContracts();
      renderUsers();
    }

    // 4) CRUD FUNCTIONS (Customers, Projects, Tasks, …)
    // --- Customers ---
    function openCustomerForm(id=''){
      const wrap = document.getElementById('customerFormWrap');
      const isEdit = !!id;
      const c = isEdit ? customers.find(x=>x.id===id) : {};
      wrap.classList.remove('d-none');
      wrap.innerHTML = `
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title">${isEdit?'Sửa':'Thêm'} khách hàng</h5>
          <div class="row g-3">
            <div class="col-md-2"><label class="form-label">ID</label><input id="cust_id" class="form-control" disabled value="${isEdit?c.id:generateCustomerId()}"></div>
            <div class="col-md-10"><label class="form-label">Name</label><input id="cust_name" class="form-control" value="${c.name||''}"></div>
            <!-- Các field khác… -->
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="${isEdit?`updateCustomer('${id}')`:'addCustomer()'}">Lưu</button>
            <button class="btn btn-outline-secondary" onclick="document.getElementById('customerFormWrap').classList.add('d-none')">Hủy</button>
          </div>
        </div></div>`;
    }
    async function addCustomer(){ /* … */ }
    async function updateCustomer(id){ /* … */ }
    async function deleteCustomer(id){ /* … */ }

    // --- Projects ---
    function openProjectForm(id=''){ /* … */ }
    async function addProject(){ /* … */ }
    async function updateProject(id){ /* … */ }
    async function deleteProject(id){ /* … */ }

    // --- Tasks ---
    function openTaskForm(id=''){
      const wrap = document.getElementById('taskFormWrap');
      const isEdit = !!id;
      const t = isEdit ? tasks.find(x=>x.task_id===id) : {};
      wrap.classList.remove('d-none');
      const projOptions = projects.map(p=>`<option value="${p.project_id}" ${p.project_id===t.project_id?'selected':''}>${p.project_name}</option>`).join('');
      const userOptions = users.map(u=>`<option value="${u.email}" ${u.email===t.assigned_to?'selected':''}>${u.name||u.email}</option>`).join('');
      wrap.innerHTML = `
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title">${isEdit?'Sửa':'Thêm'} nhiệm vụ</h5>
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Tiêu đề</label><input class="form-control" id="task_title" value="${t.title||''}"></div>
            <div class="col-md-4"><label class="form-label">Dự án</label><select id="task_project" class="form-select">${projOptions}</select></div>
            <div class="col-md-4"><label class="form-label">Người thực hiện</label><select id="task_assign" class="form-select"><option value="">--none--</option>${userOptions}</select></div>
            <div class="col-md-4"><label class="form-label">Trạng thái</label><select id="task_status" class="form-select">
              <option value="todo" ${t.status==='todo'?'selected':''}>Chưa làm</option>
              <option value="in_progress" ${t.status==='in_progress'?'selected':''}>Đang làm</option>
              <option value="waiting_review" ${t.status==='waiting_review'?'selected':''}>Chờ duyệt</option>
              <option value="done" ${t.status==='done'?'selected':''}>Hoàn thành</option>
              <option value="blocked" ${t.status==='blocked'?'selected':''}>Chặn</option>
            </select></div>
            <div class="col-md-2"><label class="form-label">Ưu tiên</label><input type="number" min="0" max="9" id="task_priority" class="form-control" value="${t.priority||0}"></div>
            <div class="col-md-3"><label class="form-label">Start</label><input type="date" id="task_start" class="form-control" value="${t.start_date||''}"></div>
            <div class="col-md-3"><label class="form-label">Due</label><input type="date" id="task_due" class="form-control" value="${t.due_date||''}"></div>
            <div class="col-md-3"><label class="form-label">Planned hrs</label><input type="number" step="0.5" min="0" id="task_planned" class="form-control" value="${t.planned_hours||0}"></div>
            <div class="col-md-3"><label class="form-label">Actual hrs</label><input type="number" step="0.5" min="0" id="task_actual" class="form-control" value="${t.actual_hours||0}"></div>
            <div class="col-12"><label class="form-label">Mô tả</label><textarea id="task_desc" class="form-control" rows="2">${t.description||''}</textarea></div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary" onclick="${isEdit?`updateTask('${id}')`:'addTask()'}">Lưu</button>
            <button class="btn btn-outline-secondary" onclick="document.getElementById('taskFormWrap').classList.add('d-none')">Hủy</button>
          </div>
        </div></div>`;
    }
    async function addTask(){ /* … */ }
    async function updateTask(id){ /* … */ }
    async function deleteTask(id){ /* … */ }

    // … (CRUD cho Opportunities, Quotes, Contracts, Users tương tự) …

    // 5) ROLE-BASED UI & AUTH
    function applyRoleUI(){
      const isAdmin = currentUser.role==='admin';
      document.getElementById('navUsers').style.display = isAdmin?'':'none';
      document.getElementById('page-users').style.display = isAdmin?'':'none';
    }

    async function enforceAuth(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){ showAuthOverlay(); return; }
      const { data: prof, error } = await sb
        .from('user_profiles')
        .select('role, active')
        .eq('email', user.email)
        .single();
      if(error || !prof || !prof.active){
        await sb.auth.signOut();
        showAuthOverlay('Email không có quyền, liên hệ Admin');
        return;
      }
      currentUser = { email:user.email, role:prof.role };
      document.getElementById('currentEmail').textContent = user.email;
      hideAuthOverlay();
      await loadAll();
      applyRoleUI();
      renderAll();
      showSection('dashboard');
    }

    sb.auth.onAuthStateChange((_e, session) => enforceAuth());

    document.getElementById('btnGoogle').onclick = () => {
      sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: window.location.origin } });
    };
    document.getElementById('btnSignOut').onclick = async (e) => {
      e.preventDefault(); await sb.auth.signOut(); location.reload();
    };

    // Navigation
    document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>{
      a.addEventListener('click',()=> showSection(a.dataset.page));
    });
    document.getElementById('btnAddCustomer').onclick     = ()=>openCustomerForm();
    document.getElementById('btnAddProject').onclick      = ()=>openProjectForm();
    document.getElementById('btnAddTask').onclick         = ()=>openTaskForm();
    document.getElementById('btnAddOpportunity').onclick  = ()=>openOppForm();
    document.getElementById('btnAddQuote').onclick        = ()=>openQuoteForm();
    document.getElementById('btnAddContract').onclick     = ()=>openContractForm();
    document.getElementById('btnAddUser').onclick         = ()=>openUserForm();

    function showSection(page){
      document.querySelectorAll('section[id^="page-"]').forEach(s=>s.classList.add('d-none'));
      document.getElementById(`page-${page}`).classList.remove('d-none');
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.classList.toggle('active', a.dataset.page===page));
    }

    // Init
    enforceAuth();
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

