<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       Project Management System - Full Single-File Version
       Updated 01-Aug-2025
       Contains: Users, Projects, customers, Contracts, Tasks, Weekly Reports, Summaries
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Management System • Bootstrap Admin</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    /* Layout */
    html, body { height:100%; margin:0; background:#f8f9fa; }
    .sidebar { width:280px; position:fixed; top:0; bottom:0; border-right:1px solid #e9ecef; background:#fff; padding:1rem; overflow:auto; }
    .content-wrap { margin-left:280px; padding:1rem; }
    .card-shadow { box-shadow:0 8px 24px rgba(0,0,0,.06); border:1px solid #eef2f7; border-radius:1rem; }
    .nav-link { border-radius:.5rem; color:#334155; }
    .nav-link.active, .nav-link:hover { background:#e7f1ff; color:#0d6efd; }

    /* Auth overlay */
    .auth-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:2000; }
    .auth-card { width:420px; border-radius:1rem; box-shadow:0 20px 40px rgba(0,0,0,.2); }

    /* Autofill suggestions */
    .suggestions { position:absolute; z-index:1050; background:#fff; border:1px solid #ddd; border-radius:.5rem; max-height:200px; overflow-y:auto; width:100%; }
    .suggestion-item { padding:.5rem; cursor:pointer; }
    .suggestion-item:hover { background:#f0f0f0; }

    /* Badges */
    .status-badge { font-size:.75rem; padding:.25rem .5rem; border-radius:.375rem; }
    .status-pending { background:#fef3c7; color:#92400e; }
    .status-in-progress { background:#dbeafe; color:#1e40af; }
    .status-completed { background:#d1fae5; color:#065f46; }

    /* Tables */
    table { width:100%; }
  </style>
</head>
<body>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập Project Management</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email trong bảng <code>user_profiles</code> và <code>active=true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập với Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <h4><i class="bi bi-kanban me-2"></i>Project Management</h4>
    <ul class="nav nav-pills flex-column mt-4" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users"><i class="bi bi-person-gear me-2"></i>Users</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>customers</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="tasks"><i class="bi bi-check2-square me-2"></i>Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="weekly-report"><i class="bi bi-calendar-week me-2"></i>Weekly Report</a></li>
      <li class="nav-item"><a class="nav-link" data-page="user-summary"><i class="bi bi-person-check me-2"></i>My Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="project-summary"><i class="bi bi-graph-up me-2"></i>Project Summary</a></li>
    </ul>
    <div class="mt-auto pt-4">
      <div class="dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
          <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px;">PM</div>
          <span id="currentEmail" class="ms-2">guest@local</span>
        </a>
        <ul class="dropdown-menu mt-2 shadow">
          <li><a id="btnSignOut" class="dropdown-item"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="content-wrap">
    <div class="container-fluid">
      <!-- Dashboard -->
      <section id="page-dashboard" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
        </div>
        <div class="row g-4">
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Users</h5><h2 id="kpiUsers">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Projects</h5><h2 id="kpiProjects">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>customers</h5><h2 id="kpicustomers">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Tasks</h5><h2 id="kpiTasks">0</h2></div></div>
        </div>
      </section>

      <!-- Users -->
      <section id="page-users" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-person-gear me-2"></i>Users</h2>
          <button id="btnAddUser" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm user</button>
        </div>
        <div id="userFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>Email</th><th>Role</th><th>Active</th><th>Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Projects -->
      <section id="page-projects" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-kanban me-2"></i>Projects</h2>
          <button id="btnAddProject" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Dự án</button>
        </div>
        <div id="projectFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>customer</th><th>Start</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- customers -->
      <section id="page-customers" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-people me-2"></i>customers</h2>
          <button id="btnAddcustomer" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Khách hàng</button>
        </div>
        <div id="customerFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>Tax</th><th>Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Contracts -->
      <section id="page-contracts" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-file-earmark-text me-2"></i>Contracts</h2>
          <button id="btnAddContract" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm HD</button>
        </div>
        <div id="contractFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Project</th><th>customer</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Tasks -->
      <section id="page-tasks" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-check2-square me-2"></i>Tasks</h2>
          <button id="btnAddTask" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Task</button>
        </div>
        <div id="taskFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>Project</th><th>User</th><th>Totals</th><th>Done</th><th>Status</th><th>Deadline</th><th>Actions</th></tr></thead>
            <tbody id="taskTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Weekly Report -->
      <section id="page-weekly-report" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-calendar-week me-2"></i>Weekly Report</h2>
          <button id="btnAddWeeklyReport" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Tạo Report</button>
        </div>
        <div id="weeklyReportFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>Week</th><th>User</th><th>Tasks</th><th>Hours</th><th>Notes</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="weeklyReportTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- My Tasks Summary -->
      <section id="page-user-summary" class="d-none mb-4">
        <h2><i class="bi bi-person-check me-2"></i>My Tasks Summary</h2>
        <div class="row g-4 mt-3">
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksPending">0</h4><p>Pending</p></div></div>
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksInProgress">0</h4><p>In Progress</p></div></div>
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksCompleted">0</h4><p>Completed</p></div></div>
        </div>
        <div class="card card-shadow mt-3 p-3">
          <table class="table table-hover">
            <thead><tr><th>Task</th><th>Project</th><th>Deadline</th><th>Status</th><th>Progress</th></tr></thead>
            <tbody id="myTasksTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Project Summary -->
      <section id="page-project-summary" class="d-none mb-4">
        <h2><i class="bi bi-graph-up me-2"></i>Project Summary</h2>
        <div class="card card-shadow mt-3 p-3">
          <table class="table table-hover">
            <thead><tr><th>Project</th><th>customer</th><th>Total</th><th>Done</th><th>In Progress</th><th>Pending</th><th>Progress</th><th>Status</th></tr></thead>
            <tbody id="projectSummaryTbody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 0) Supabase Config
    const SUPABASE_URL = 'https://mfbdfhvqnxuhxwscdffv.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
    const sb = supabase.createcustomer(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) State & Helpers
    let currentUser = { email: null, role: 'user' };
    let users=[], projects=[], customers=[], contracts=[], tasks=[], weeklyReports=[];
    const pad=(n,w)=>String(n).padStart(w,'0');
    function getWeekNumber(d=new Date()){
      d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
      d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d-yearStart)/86400000)+1)/7);
    }
    const money=n=>(n||0).toLocaleString('vi-VN');
    // ID generators: generatecustomerId, generateProjectId, generateContractId, generateTaskId

    // 2) Auth Helpers
    function showAuth(msg=''){
      document.getElementById('authError').textContent=msg;
      document.getElementById('authOverlay').classList.remove('d-none');
    }
    function hideAuth(){
      document.getElementById('authOverlay').classList.add('d-none');
    }

    async function enforceAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ showAuth(); return false; }
      const { data: prof, error } = await sb.from('user_profiles').select('role,active').eq('email',user.email).single();
      if(error || !prof || !prof.active){ showAuth('Email chưa active'); await sb.auth.signOut(); return false; }
      currentUser={ email:user.email, role:prof.role };
      document.getElementById('currentEmail').textContent=currentUser.email;
      hideAuth();
      return true;
    }

    // Google OAuth
    document.getElementById('btnGoogle').onclick = ()=>{
      sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo:location.href } });
    };
    document.getElementById('btnSignOut').onclick = async e=>{
      e.preventDefault(); await sb.auth.signOut(); location.reload();
    };
    sb.auth.onAuthStateChange(async(event)=>{
      if(event==='SIGNED_IN'){ if(await enforceAuth()){ await loadAll(); showSection('dashboard'); }}
      if(event==='SIGNED_OUT'){ showAuth(); }
    });

    // 3) Data Loading & Render
    async function loadData(){
      const [u,p,cus,con,ta,wr] = await Promise.all([
        sb.from('user_profiles').select('*'),
        sb.from('projects').select('*'),
        sb.from('customers').select('*'),
        sb.from('contracts').select('*'),
        sb.from('tasks').select('*'),
        sb.from('weekly_reports').select('*')
      ]);
      users=u.data; projects=p.data; customers=cus.data;
      contracts=con.data; tasks=ta.data; weeklyReports=wr.data;
      setKPIs(); updateUserTaskSummary(); renderProjectSummary(); renderAllTables();
    }
    async function loadAll(){ await loadData(); }

    // 4) KPI functions (setKPIs, updateUserTaskSummary)
    // 5) Render functions: renderUsers, renderProjects, rendercustomers, renderContracts, renderTasks, renderWeeklyReports, renderMyTasks, renderProjectSummary
    // 6) Form functions: showUserForm, showProjectForm, showcustomerForm, showContractForm, showTaskForm (with setupProjectAutofill), showWeeklyReportForm
    // 7) CRUD: editUser, deleteUser, editProject, deleteProject, ...

    // 8) Navigation
    function showSection(page){
      document.querySelectorAll('[id^="page-"]').forEach(s=>s.classList.add('d-none'));
      document.getElementById(`page-${page}`).classList.remove('d-none');
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.classList.toggle('active', a.dataset.page===page));
    }

    // 9) Init
    document.addEventListener('DOMContentLoaded', async()=>{
      if(await enforceAuth()){ await loadAll(); showSection('dashboard'); }
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); showSection(a.dataset.page); }));
      // Add button listeners
      document.getElementById('btnAddUser').onclick = ()=>showUserForm();
      document.getElementById('btnAddProject').onclick = ()=>showProjectForm();
      document.getElementById('btnAddcustomer').onclick = ()=>showcustomerForm();
      document.getElementById('btnAddContract').onclick = ()=>showContractForm();
      document.getElementById('btnAddTask').onclick = ()=>showTaskForm();
      document.getElementById('btnAddWeeklyReport').onclick = ()=>showWeeklyReportForm();
    });
  </script>
</body>
</html>
