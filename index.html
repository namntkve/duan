<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       Project Management System – Single‑file WebApp
       Updated 01‑Aug‑2025
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Management System • Bootstrap Admin</title>

  <!-- Bootstrap 5 CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    html,body{height:100%;background:#f8f9fa}
    .sidebar{width:280px;min-height:100vh;position:sticky;top:0;border-right:1px solid #e9ecef;background:#fff}
    .sidebar .nav-link{border-radius:.5rem;color:#334155}
    .sidebar .nav-link.active,.sidebar .nav-link:hover{background:#e7f1ff;color:#0d6efd}
    .content-wrap{margin-left:0}@media (min-width:992px){.content-wrap{margin-left:280px}.sidebar{position:fixed}}
    .card-shadow{box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid #eef2f7;border-radius:1rem}

    /* Autofill */
    .suggestions{position:absolute;z-index:1050;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;max-height:260px;overflow-y:auto;width:100%;box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .suggestion-item{padding:.5rem .75rem;cursor:pointer}.suggestion-item:hover{background:#f5f7fb}

    .section-anchor{scroll-margin-top:80px}

    /* Auth overlay */
    .auth-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.55);backdrop-filter:blur(2px);z-index:3000}
    .auth-card{width:420px;border-radius:1rem;box-shadow:0 20px 40px rgba(0,0,0,.2)}

    /* Badges */
    .status-badge{font-size:.75rem;padding:.25rem .5rem;border-radius:.375rem}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-in-progress{background:#dbeafe;color:#1e40af}
    .status-completed{background:#d1fae5;color:#065f46}
  </style>
</head>
<body>

  <!-- =========== AUTH OVERLAY =========== -->
  <div id="authOverlay" class="auth-overlay d-none">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập Project Management</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email nằm trong bảng <code>user_profiles</code> và <code>active = true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập với Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- =========== SIDEBAR =========== -->
  <aside class="sidebar p-3">
    <a class="d-flex align-items-center mb-3 text-decoration-none"><span class="fs-5 fw-bold"><i class="bi bi-kanban me-2"></i>Project Management</span></a><hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users"><i class="bi bi-person-gear me-2"></i>Users</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="clients"><i class="bi bi-people me-2"></i>Clients</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="tasks"><i class="bi bi-check2-square me-2"></i>Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="weekly-report"><i class="bi bi-calendar-week me-2"></i>Weekly Report</a></li>
      <li class="nav-item"><a class="nav-link" data-page="user-summary"><i class="bi bi-person-check me-2"></i>My Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="project-summary" id="navProjectSummary"><i class="bi bi-graph-up me-2"></i>Project Summary</a></li>
    </ul><hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name=PM&background=0D6EFD&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <strong id="currentEmail">guest@local</strong>
      </a>
      <ul class="dropdown-menu shadow"><li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li></ul>
    </div>
  </aside>

  <!-- =========== MAIN CONTENT =========== -->
  <main class="content-wrap"><div class="container-fluid py-4">
    <!-- ==== DASHBOARD ==== -->
    <section id="page-dashboard" class="section-anchor">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1></div>
      <div class="row g-4">
        <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Users</h6><h2 class="fw-bold mb-0" id="kpiUsers">0</h2></div></div></div>
        <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Projects</h6><h2 class="fw-bold mb-0" id="kpiProjects">0</h2></div></div></div>
        <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Clients</h6><h2 class="fw-bold mb-0" id="kpiClients">0</h2></div></div></div>
        <div class="col-6 col-lg-3"><div class="card card-shadow"><div class="card-body"><h6 class="text-secondary text-uppercase mb-1">Tasks</h6><h2 class="fw-bold mb-0" id="kpiTasks">0</h2></div></div></div>
      </div>
      <div class="row g-4 mt-2"><div class="col-md-6"><div class="card card-shadow"><div class="card-body">
        <h6 class="text-secondary text-uppercase mb-3">Task Status Overview</h6>
        <div class="d-flex justify-content-between mb-2"><span>Pending</span><span class="fw-bold" id="kpiTasksPending">0</span></div>
        <div class="d-flex justify-content-between mb-2"><span>In Progress</span><span class="fw-bold" id="kpiTasksInProgress">0</span></div>
        <div class="d-flex justify-content-between"><span>Completed</span><span class="fw-bold" id="kpiTasksCompleted">0</span></div>
      </div></div></div>
      <div class="col-md-6"><div class="card card-shadow"><div class="card-body">
        <h6 class="text-secondary text-uppercase mb-3">Project Status Overview</h6>
        <div class="d-flex justify-content-between mb-2"><span>Active</span><span class="fw-bold" id="kpiProjectsActive">0</span></div>
        <div class="d-flex justify-content-between mb-2"><span>On Hold</span><span class="fw-bold" id="kpiProjectsOnHold">0</span></div>
        <div class="d-flex justify-content-between"><span>Completed</span><span class="fw-bold" id="kpiProjectsCompleted">0</span></div>
      </div></div></div></div>
    </section>

    <!-- ==== USERS ==== -->
    <section id="page-users" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Thêm user</button></div></div>
      <div id="userFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>Email</th><th>Role</th><th>Active</th><th style="width:140px;">Actions</th></tr></thead>
        <tbody id="userTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== PROJECTS ==== -->
    <section id="page-projects" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div></div>
      <div id="projectFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>ID</th><th>Tên dự án</th><th>Khách hàng</th><th>Start</th><th>End</th><th>Status</th><th style="width:120px;">Actions</th></tr></thead>
        <tbody id="projectTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== CLIENTS ==== -->
    <section id="page-clients" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Clients</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddClient"><i class="bi bi-plus-lg me-1"></i>Thêm khách hàng</button></div></div>
      <div id="clientFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>Tax</th><th style="width:120px;">Actions</th></tr></thead>
        <tbody id="clientTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== CONTRACTS ==== -->
    <section id="page-contracts" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Contracts</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddContract"><i class="bi bi-plus-lg me-1"></i>Thêm hợp đồng</button></div></div>
      <div id="contractFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>ID</th><th>Dự án</th><th>Khách hàng</th><th>Giá trị</th><th>Status</th><th style="width:140px;">Actions</th></tr></thead>
        <tbody id="contractTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== TASKS ==== -->
    <section id="page-tasks" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-check2-square me-2"></i>Tasks</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddTask"><i class="bi bi-plus-lg me-1"></i>Thêm task</button></div></div>
      <div id="taskFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>ID</th><th>Tên Task</th><th>Dự án</th><th>Người thực hiện</th><th>Tổng thời gian (h)</th><th>Đã thực hiện (h)</th><th>Tình trạng</th><th>Deadline</th><th style="width:140px;">Actions</th></tr></thead>
        <tbody id="taskTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== WEEKLY REPORT ==== -->
    <section id="page-weekly-report" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-calendar-week me-2"></i>Weekly Report</h1><div class="ms-auto"><button class="btn btn-primary" id="btnAddWeeklyReport"><i class="bi bi-plus-lg me-1"></i>Tạo báo cáo tuần</button></div></div>
      <div id="weeklyReportFormWrap" class="d-none"></div>
      <div class="card card-shadow"><div class="card-body table-responsive"><table class="table table-hover table-sm align-middle">
        <thead class="table-light"><tr><th>Tuần</th><th>Người báo cáo</th><th>Tasks hoàn thành</th><th>Tổng thời gian (h)</th><th>Đề xuất</th><th>Ngày tạo</th><th style="width:120px;">Actions</th></tr></thead>
        <tbody id="weeklyReportTbody"></tbody>
      </table></div></div>
    </section>

    <!-- ==== USER SUMMARY ==== -->
    <section id="page-user-summary" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-person-check me-2"></i>My Tasks Summary</h1></div>
      <div class="row g-4 mb-4">
        <div class="col-md-4"><div class="card card-shadow"><div class="card-body text-center"><h3 class="fw-bold text-warning" id="myTasksPending">0</h3><p class="mb-0">Pending Tasks</p></div></div></div>
        <div class="col-md-4"><div class="card card-shadow"><div class="card-body text-center"><h3 class="fw-bold text-primary" id="myTasksInProgress">0</h3><p class="mb-0">In Progress</p></div></div></div>
        <div class="col-md-4"><div class="card card-shadow"><div class="card-body text-center"><h3 class="fw-bold text-success" id="myTasksCompleted">0</h3><p class="mb-0">Completed</p></div></div></div>
      </div>
      <div class="card card-shadow"><div class="card-body"><h5 class="card-title">My Tasks</h5><div class="table-responsive"><table class="table table-hover table-sm align-middle"><thead class="table-light"><tr><th>Task</th><th>Dự án</th><th>Deadline</th><th>Tình trạng</th><th>Progress</th></tr></thead><tbody id="myTasksTbody"></tbody></table></div></div></div>
    </section>

    <!-- ==== PROJECT SUMMARY ==== -->
    <section id="page-project-summary" class="section-anchor d-none">
      <div class="d-flex align-items-center mb-4"><h1 class="h3 mb-0"><i class="bi bi-graph-up me-2"></i>Project Summary</h1></div>
      <div class="card card-shadow"><div class="card-body"><h5 class="card-title">Projects Overview</h5><div class="table-responsive"><table class="table table-hover table-sm align-middle"><thead class="table-light"><tr><th>Dự án</th><th>Khách hàng</th><th>Tổng Tasks</th><th>Hoàn thành</th><th>Đang thực hiện</th><th>Pending</th><th>Progress</th><th>Status</th></tr></thead><tbody id="projectSummaryTbody"></tbody></table></div></div></div>
    </section>

  </div></main>

  <!-- =========== SCRIPTS =========== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ===== 0) SUPABASE CONFIG ===== */
    const SUPABASE_URL  = 'https://mfbdfhvqnxuhxwscdffv.supabase.co';
    const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mYmRmaHZxbnh1aHh3c2NkZmZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDE3MjIsImV4cCI6MjA2OTYxNzcyMn0.rV15XLuKNXR05uEXOunzCkPoPGAVNKrzMP4iffw-vxk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ===== 1) STATE ===== */
    let currentUser = { email:null, role:'user' };
    let users=[], projects=[], clients=[], contracts=[], tasks=[], weeklyReports=[];

    /* ===== 2) HELPERS ===== */
    const pad=(n,w)=>String(n).padStart(w,'0');
    function getWeekNumber(d=new Date()){d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));return Math.ceil((((d-yStart)/864e5)+1)/7);}
    const money=n=>(n||0).toLocaleString('vi-VN');

    function generateClientId(){const used=clients.map(c=>parseInt((c.id||'').slice(1),10)).filter(Number.isFinite);for(let i=1;i<10000;i++)if(!used.includes(i))return 'C'+pad(i,4);throw Error('Hết mã khách hàng');}
    function generateProjectId(){const y=new Date().getFullYear().toString().slice(-2);const used=projects.filter(p=>p.project_id.startsWith('P_'+y)).map(p=>parseInt(p.project_id.slice(4),10)).filter(Number.isFinite);for(let i=1;i<1000;i++)if(!used.includes(i))return 'P_'+y+pad(i,3);throw Error('Hết mã dự án');}
    function generateContractId(){const now=new Date(),y=now.getFullYear().toString().slice(-2),w=pad(getWeekNumber(now),2);const used=contracts.filter(c=>c.contract_id.startsWith(`HD_${y}${w}`)).map(c=>parseInt(c.contract_id.slice(7),10)).filter(Number.isFinite);for(let i=1;i<=99;i++)if(!used.includes(i))return `HD_${y}${w}${pad(i,2)}`;throw Error('Hết mã hợp đồng');}
    function generateTaskId(){const used=tasks.map(t=>parseInt((t.task_id||'').slice(1),10)).filter(Number.isFinite);for(let i=1;i<100000;i++)if(!used.includes(i))return 'T'+pad(i,5);throw Error('Hết mã task');}

    /* ===== 3) AUTH ===== */
    function showAuth(msg=''){document.getElementById('authError').textContent=msg;document.getElementById('authOverlay').classList.remove('d-none');}
    function hideAuth(){document.getElementById('authOverlay').classList.add('d-none');}

    async function enforceAuth(){
      try{
        const { data:{ user } } = await sb.auth.getUser();
        if(!user){showAuth();return false;}
        const { data:prof,error } = await sb.from('user_profiles').select('role,active').eq('email',user.email).single();
        if(error||!prof||!prof.active){showAuth('Email chưa được cấp quyền, liên hệ admin!');await sb.auth.signOut();return false;}
        currentUser={email:user.email,role:prof.role||'user'};
        document.getElementById('currentEmail').textContent=currentUser.email;
        hideAuth();await loadAll();applyRoleUI();renderAll();showSection('dashboard');return true;
      }catch(e){console.error(e);showAuth('Không thể xác thực, thử lại!');return false;}
    }

    // giữ API cũ
    async function checkAuth(){return enforceAuth();}
    function signInWithGoogle(){sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:location.href}});}

    document.getElementById('btnGoogle').onclick=signInWithGoogle;
    document.getElementById('btnSignOut').onclick=async e=>{e.preventDefault();await sb.auth.signOut();location.reload();};
    sb.auth.onAuthStateChange(()=>enforceAuth());

    /* ===== 4) DATA ===== */
    async function loadData(){
      try{
        const [u,p,c,con,t,r]=await Promise.all([
          sb.from('user_profiles').select('*'),
          sb.from('projects').select('*'),
          sb.from('customers').select('*'),
          sb.from('contracts').select('*'),
          sb.from('tasks').select('*'),
          sb.from('weekly_reports').select('*')
        ]);
        users=u.data||[];projects=p.data||[];clients=c.data||[];contracts=con.data||[];tasks=t.data||[];weeklyReports=r.data||[];
        setKPIs();updateUserTaskSummary();renderProjectSummary();renderAllTables();
      }catch(err){console.error('loadData',err);}
    }
    async function loadAll(){await loadData();}

    /* ===== 5) KPI & SUMMARY RENDERS ===== */
    function setKPIs(){
      document.getElementById('kpiUsers').textContent=users.length;
      document.getElementById('kpiProjects').textContent=projects.length;
      document.getElementById('kpiClients').textContent=clients.length;
      document.getElementById('kpiTasks').textContent=tasks.length;
      const p=tasks.filter(t=>t.status==='pending').length,
            ip=tasks.filter(t=>t.status==='in_progress').length,
            c=tasks.filter(t=>t.status==='completed').length;
      document.getElementById('kpiTasksPending').textContent=p;
      document.getElementById('kpiTasksInProgress').textContent=ip;
      document.getElementById('kpiTasksCompleted').textContent=c;
      const a=projects.filter(p=>p.status==='active').length,
            oh=projects.filter(p=>p.status==='on_hold').length,
            cp=projects.filter(p=>p.status==='completed').length;
      document.getElementById('kpiProjectsActive').textContent=a;
      document.getElementById('kpiProjectsOnHold').textContent=oh;
      document.getElementById('kpiProjectsCompleted').textContent=cp;
    }

    function updateUserTaskSummary(){
      const my=tasks.filter(t=>t.assigned_user===currentUser.email);
      document.getElementById('myTasksPending').textContent=my.filter(t=>t.status==='pending').length;
      document.getElementById('myTasksInProgress').textContent=my.filter(t=>t.status==='in_progress').length;
      document.getElementById('myTasksCompleted').textContent=my.filter(t=>t.status==='completed').length;
      renderMyTasks();
    }

    /* ===== 6) FULL RENDER & CRUD ===== */
    /* ---- Các hàm renderUsers, renderProjects, renderClients, renderContracts, renderTasks, renderWeeklyReports,
            showUserForm, showProjectForm, showClientForm, showContractForm, showTaskForm, showWeeklyReportForm,
            cùng các hàm edit/delete...  được GIỮ NGUYÊN từ mã gốc của bạn.
            !!!!  CHỈ copy đúng nguyên bản từ file cũ rồi dán vào đây   !!!! */

    /* ===== 7) NAVIGATION & BOOTSTRAP ===== */
    function showSection(page){document.querySelectorAll('[id^="page-"]').forEach(el=>el.classList.add('d-none'));document.getElementById(`page-${page}`).classList.remove('d-none');document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.classList.toggle('active',a.dataset.page===page));}
    function applyRoleUI(){document.getElementById('navProjectSummary').style.display=['admin','manager','BOM'].includes(currentUser.role)?'':'';}

    document.addEventListener('DOMContentLoaded',()=>{
      enforceAuth();
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();const page=a.dataset.page;showSection(page);if(page==='user-summary')updateUserTaskSummary();if(page==='project-summary')renderProjectSummary();}));
      // Add‑buttons (listeners sẽ được gắn trong renderAllTables khi cần)
    });
  </script>
</body>
</html>
