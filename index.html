
    
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Management System</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoP+FZx0p3M9x9M9kF4YRq+8abtTE1Pi6jizo"
    crossorigin="anonymous"
  />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/module/supabase.js"></script>
  <style>
    body { padding-top: 4.5rem; }
    .nav-link.active { font-weight: bold; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">VSEC PMC</a>
      <button
        class="navbar-toggler"
        type="button" data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div
        class="collapse navbar-collapse justify-content-end"
        id="navbarNav"
      >
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" data-section="projects" href="#">Projects</a></li>
          <li class="nav-item"><a class="nav-link" data-section="tasks" href="#">Tasks</a></li>
          <li class="nav-item"><a class="nav-link" data-section="reports" href="#">Weekly Reports</a></li>
          <li class="nav-item"><a class="nav-link" data-section="summary" href="#">Summary</a></li>
          <li class="nav-item"><button id="btn-logout" class="btn btn-outline-light btn-sm">Log out</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main container -->
  <div class="container">
    <!-- Login prompt -->
    <div id="login-screen" class="text-center mt-5">
      <h3>Please sign in with Google</h3>
      <button id="btn-login" class="btn btn-primary">Sign in with Google</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="section hidden">
      <h2>Welcome, <span id="user-email"></span></h2>
      <p>Use the menu to navigate through the system.</p>
    </div>

    <!-- Projects Section -->
    <div id="projects" class="section hidden">
      <h2>Projects</h2>
      <button id="btn-new-project" class="btn btn-success mb-3">New Project</button>
      <table class="table table-striped">
        <thead>
          <tr><th>ID</th><th>Name</th><th>Customer</th><th>Start</th><th>End</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="projects-body"></tbody>
      </table>
    </div>

    <!-- Tasks Section -->
    <div id="tasks" class="section hidden">
      <h2>Tasks</h2>
      <button id="btn-new-task" class="btn btn-success mb-3">New Task</button>
      <table class="table table-striped">
        <thead>
          <tr><th>Title</th><th>Project</th><th>Assigned To</th><th>Status</th><th>Due</th><th>Actions</th></tr>
        </thead>
        <tbody id="tasks-body"></tbody>
      </table>
    </div>

    <!-- Weekly Reports Section -->
    <div id="reports" class="section hidden">
      <h2>Weekly Reports</h2>
      <button id="btn-new-report" class="btn btn-success mb-3">New Report</button>
      <table class="table table-striped">
        <thead>
          <tr><th>Week</th><th>Summary</th><th>Actions</th></tr>
        </thead>
        <tbody id="reports-body"></tbody>
      </table>
    </div>

    <!-- Summary Section -->
    <div id="summary" class="section hidden">
      <h2>Project Summary</h2>
      <table class="table table-striped">
        <thead>
          <tr><th>Project</th><th>Week</th><th>Total</th><th>Done</th><th>Progress %</th></tr>
        </thead>
        <tbody id="summary-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Modals -->
  <!-- Project Modal -->
  <div class="modal fade" id="modal-project" tabindex="-1">
    <div class="modal-dialog">
      <form id="form-project" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="project-id" />
          <div class="mb-3">
            <label>Name</label>
            <input id="project-name" class="form-control" required />
          </div>
          <div class="mb-3">
            <label>Customer ID</label>
            <input id="project-customer" class="form-control" required />
          </div>
          <div class="mb-3">
            <label>Start Date</label>
            <input id="project-start" type="date" class="form-control" />
          </div>
          <div class="mb-3">
            <label>End Date</label>
            <input id="project-end" type="date" class="form-control" />
          </div>
          <div class="mb-3">
            <label>Status</label>
            <input id="project-status" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Modal -->
  <div class="modal fade" id="modal-task" tabindex="-1">
    <div class="modal-dialog">
      <form id="form-task" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="task-id" />
          <div class="mb-3">
            <label>Title</label>
            <input id="task-title" class="form-control" required />
          </div>
          <div class="mb-3">
            <label>Project ID</label>
            <input id="task-project" class="form-control" required />
          </div>
          <div class="mb-3">
            <label>Assigned To (email)</label>
            <input id="task-user" type="email" class="form-control" />
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select id="task-status" class="form-select">
              <option value="todo">To Do</option>
              <option value="in_progress">In Progress</option>
              <option value="waiting_review">Waiting Review</option>
              <option value="done">Done</option>
              <option value="blocked">Blocked</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Due Date</label>
            <input id="task-due" type="date" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal fade" id="modal-report" tabindex="-1">
    <div class="modal-dialog">
      <form id="form-report" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Weekly Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="report-id" />
          <div class="mb-3">
            <label>Year</label>
            <input id="report-year" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label>Week #</label>
            <input id="report-week" type="number" class="form-control" required min="1" max="53"/>
          </div>
          <div class="mb-3">
            <label>Summary</label>
            <textarea id="report-summary" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS & Dependencies -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    // ---------- Supabase init ----------
   const SUPABASE_URL = 'https://jhybbyzpgyfxtfpnuhqt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoeWJieXpwZ3lmeHRmcG51aHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTg2MTgsImV4cCI6MjA2OTU5NDYxOH0.d0jrlFshaX-y_HSuVL_LOo0JsPvD1qqm4ceK1styUaQ';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ---------- DOM references ----------
    const loginScreen = document.getElementById('login-screen');
    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const userEmailSpan = document.getElementById('user-email');
    const sections = document.querySelectorAll('.section');
    const navLinks = document.querySelectorAll('.nav-link[data-section]');

    // Modal forms
    const modalProjectElem = new bootstrap.Modal(document.getElementById('modal-project'));
    const formProject = document.getElementById('form-project');
    const modalTaskElem = new bootstrap.Modal(document.getElementById('modal-task'));
    const formTask = document.getElementById('form-task');
    const modalReportElem = new bootstrap.Modal(document.getElementById('modal-report'));
    const formReport = document.getElementById('form-report');

    // Data holders
    let currentUser = null;
    let projects = [];
    let tasks = [];
    let reports = [];
    let summaries = [];

    // ---------- AUTH handlers ----------
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        currentUser = session.user;
        showApp();
      } else {
        showLogin();
      }
    }

    btnLogin.addEventListener('click', async () => {
      await supabase.auth.signInWithOAuth({ provider: 'google' });
    });

    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      location.reload();
    });

    supabase.auth.onAuthStateChange((_event, session) => {
      checkAuth();
    });

    // ---------- UI helpers ----------
    function showLogin() {
      loginScreen.classList.remove('hidden');
      sections.forEach(s => s.classList.add('hidden'));
      btnLogout.style.display = 'none';
    }

    function showApp() {
      loginScreen.classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      btnLogout.style.display = 'inline-block';
      userEmailSpan.textContent = currentUser.email;
      loadAll();
    }

    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        const sec = link.dataset.section;
        sections.forEach(s => s.id === sec ? s.classList.remove('hidden') : s.classList.add('hidden'));
      });
    });

    // ---------- Data loading ----------
    async function loadAll() {
      await Promise.all([loadProjects(), loadTasks(), loadReports(), loadSummary()]);
    }

    async function loadProjects() {
      let { data, error } = await supabase
        .from('projects')
        .select('*');
      if (!error) {
        projects = data;
        renderProjects();
      }
    }

    function renderProjects() {
      const tbody = document.getElementById('projects-body');
      tbody.innerHTML = '';
      projects.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.project_id}</td>
          <td>${p.project_name}</td>
          <td>${p.customer_id}</td>
          <td>${p.start_date || ''}</td>
          <td>${p.end_date || ''}</td>
          <td>${p.status || ''}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editProject('${p.project_id}')">✎</button>
            <button class="btn btn-sm btn-danger" onclick="deleteProject('${p.project_id}')">🗑️</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadTasks() {
      let { data, error } = await supabase
        .from('tasks')
        .select('*');
      if (!error) {
        tasks = data;
        renderTasks();
      }
    }

    function renderTasks() {
      const tbody = document.getElementById('tasks-body');
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.title}</td>
          <td>${t.project_id}</td>
          <td>${t.assigned_to || ''}</td>
          <td>${t.status}</td>
          <td>${t.due_date || ''}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editTask('${t.task_id}')">✎</button>
            <button class="btn btn-sm btn-danger" onclick="deleteTask('${t.task_id}')">🗑️</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadReports() {
      let { data, error } = await supabase
        .from('weekly_reports')
        .select('*')
        .eq('user_email', currentUser.email);
      if (!error) {
        reports = data;
        renderReports();
      }
    }

    function renderReports() {
      const tbody = document.getElementById('reports-body');
      tbody.innerHTML = '';
      reports.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.week_year}-W${r.week_number}</td>
          <td>${r.summary || ''}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editReport('${r.weekly_report_id}')">✎</button>
            <button class="btn btn-sm btn-danger" onclick="deleteReport('${r.weekly_report_id}')">🗑️</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadSummary() {
      let { data, error } = await supabase
        .from('project_summary')
        .select('*');
      if (!error) {
        summaries = data;
        renderSummary();
      }
    }

    function renderSummary() {
      const tbody = document.getElementById('summary-body');
      tbody.innerHTML = '';
      summaries.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.project_id}</td>
          <td>${s.week_year}-W${s.week_number}</td>
          <td>${s.total_tasks}</td>
          <td>${s.completed_tasks}</td>
          <td>${s.progress_percent}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------- CRUD Projects ----------
    document.getElementById('btn-new-project').onclick = () => {
      formProject.reset();
      document.getElementById('project-id').value = '';
      modalProjectElem.show();
    };
    async function editProject(id) {
      const p = projects.find(x => x.project_id === id);
      document.getElementById('project-id').value = p.project_id;
      document.getElementById('project-name').value = p.project_name;
      document.getElementById('project-customer').value = p.customer_id;
      document.getElementById('project-start').value = p.start_date;
      document.getElementById('project-end').value = p.end_date;
      document.getElementById('project-status').value = p.status;
      modalProjectElem.show();
    }
    formProject.onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('project-id').value;
      const payload = {
        project_id: id || `P${Date.now()}`,
        project_name: document.getElementById('project-name').value,
        customer_id: document.getElementById('project-customer').value,
        start_date: document.getElementById('project-start').value || null,
        end_date: document.getElementById('project-end').value || null,
        status: document.getElementById('project-status').value
      };
      if (id) {
        await supabase.from('projects').update(payload).eq('project_id', id);
      } else {
        await supabase.from('projects').insert(payload);
      }
      modalProjectElem.hide();
      loadProjects();
    };
    async function deleteProject(id) {
      if (confirm('Delete project ' + id + '?')) {
        await supabase.from('projects').delete().eq('project_id', id);
        loadProjects();
      }
    }

    // ---------- CRUD Tasks ----------
    document.getElementById('btn-new-task').onclick = () => {
      formTask.reset();
      document.getElementById('task-id').value = '';
      modalTaskElem.show();
    };
    async function editTask(id) {
      const t = tasks.find(x => x.task_id === id);
      document.getElementById('task-id').value = t.task_id;
      document.getElementById('task-title').value = t.title;
      document.getElementById('task-project').value = t.project_id;
      document.getElementById('task-user').value = t.assigned_to;
      document.getElementById('task-status').value = t.status;
      document.getElementById('task-due').value = t.due_date;
      modalTaskElem.show();
    }
    formTask.onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('task-id').value;
      const payload = {
        title: document.getElementById('task-title').value,
        project_id: document.getElementById('task-project').value,
        assigned_to: document.getElementById('task-user').value,
        status: document.getElementById('task-status').value,
        due_date: document.getElementById('task-due').value || null
      };
      if (id) {
        await supabase.from('tasks').update(payload).eq('task_id', id);
      } else {
        await supabase.from('tasks').insert(payload);
      }
      modalTaskElem.hide();
      loadTasks();
    };
    async function deleteTask(id) {
      if (confirm('Delete task?')) {
        await supabase.from('tasks').delete().eq('task_id', id);
        loadTasks();
      }
    }

    // ---------- CRUD Reports ----------
    document.getElementById('btn-new-report').onclick = () => {
      formReport.reset();
      document.getElementById('report-id').value = '';
      modalReportElem.show();
    };
    async function editReport(id) {
      const r = reports.find(x => x.weekly_report_id === id);
      document.getElementById('report-id').value = r.weekly_report_id;
      document.getElementById('report-year').value = r.week_year;
      document.getElementById('report-week').value = r.week_number;
      document.getElementById('report-summary').value = r.summary;
      modalReportElem.show();
    }
    formReport.onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById('report-id').value;
      const payload = {
        user_email: currentUser.email,
        week_year: parseInt(document.getElementById('report-year').value),
        week_number: parseInt(document.getElementById('report-week').value),
        summary: document.getElementById('report-summary').value
      };
      if (id) {
        await supabase.from('weekly_reports').update(payload).eq('weekly_report_id', id);
      } else {
        await supabase.from('weekly_reports').insert(payload);
      }
      modalReportElem.hide();
      loadReports();
    };
    async function deleteReport(id) {
      if (confirm('Delete report?')) {
        await supabase.from('weekly_reports').delete().eq('weekly_report_id', id);
        loadReports();
      }
    }

    // ---------- Initialize ----------
    checkAuth();
  </script>
</body>
</html>
