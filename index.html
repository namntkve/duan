<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       Project Management System - Full Single-File Version
       Updated 01-Aug-2025
       Contains: Users, Projects, customers, Contracts, Tasks, Weekly Reports, Summaries
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Management System • Bootstrap Admin</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    /* Layout */
    html, body { height:100%; margin:0; background:#f8f9fa; }
    .sidebar { width:280px; position:fixed; top:0; bottom:0; border-right:1px solid #e9ecef; background:#fff; padding:1rem; overflow:auto; }
    .content-wrap { margin-left:280px; padding:1rem; }
    .card-shadow { box-shadow:0 8px 24px rgba(0,0,0,.06); border:1px solid #eef2f7; border-radius:1rem; }
    .nav-link { border-radius:.5rem; color:#334155; }
    .nav-link.active, .nav-link:hover { background:#e7f1ff; color:#0d6efd; }

    /* Auth overlay */
    .auth-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,.55); backdrop-filter:blur(2px); z-index:2000; }
    .auth-card { width:420px; border-radius:1rem; box-shadow:0 20px 40px rgba(0,0,0,.2); }

    /* Autofill suggestions */
    .suggestions { position:absolute; z-index:1050; background:#fff; border:1px solid #ddd; border-radius:.5rem; max-height:200px; overflow-y:auto; width:100%; }
    .suggestion-item { padding:.5rem; cursor:pointer; }
    .suggestion-item:hover { background:#f0f0f0; }

    /* Badges */
    .status-badge { font-size:.75rem; padding:.25rem .5rem; border-radius:.375rem; }
    .status-pending { background:#fef3c7; color:#92400e; }
    .status-in-progress { background:#dbeafe; color:#1e40af; }
    .status-completed { background:#d1fae5; color:#065f46; }

    /* Tables */
    table { width:100%; }
  </style>
</head>
<body>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay" class="auth-overlay">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập Project Management</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email trong bảng <code>user_profiles</code> và <code>active=true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập với Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <h4><i class="bi bi-kanban me-2"></i>Project Management</h4>
    <ul class="nav nav-pills flex-column mt-4" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users"><i class="bi bi-person-gear me-2"></i>Users</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="customers"><i class="bi bi-people me-2"></i>customers</a></li>
      <li class="nav-item"><a class="nav-link" data-page="contracts"><i class="bi bi-file-earmark-text me-2"></i>Contracts</a></li>
      <li class="nav-item"><a class="nav-link" data-page="tasks"><i class="bi bi-check2-square me-2"></i>Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="weekly-report"><i class="bi bi-calendar-week me-2"></i>Weekly Report</a></li>
      <li class="nav-item"><a class="nav-link" data-page="user-summary"><i class="bi bi-person-check me-2"></i>My Tasks</a></li>
      <li class="nav-item"><a class="nav-link" data-page="project-summary"><i class="bi bi-graph-up me-2"></i>Project Summary</a></li>
    </ul>
    <div class="mt-auto pt-4">
      <div class="dropdown">
        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
          <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:32px;height:32px;">PM</div>
          <span id="currentEmail" class="ms-2">guest@local</span>
        </a>
        <ul class="dropdown-menu mt-2 shadow">
          <li><a id="btnSignOut" class="dropdown-item"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="content-wrap">
    <div class="container-fluid">
      <!-- Dashboard -->
      <section id="page-dashboard" class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
        </div>
        <div class="row g-4">
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Users</h5><h2 id="kpiUsers">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Projects</h5><h2 id="kpiProjects">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>customers</h5><h2 id="kpicustomers">0</h2></div></div>
          <div class="col-6 col-lg-3"><div class="card card-shadow p-3 text-center"><h5>Tasks</h5><h2 id="kpiTasks">0</h2></div></div>
        </div>
      </section>

      <!-- Users -->
      <section id="page-users" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-person-gear me-2"></i>Users</h2>
          <button id="btnAddUser" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm user</button>
        </div>
        <div id="userFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>Email</th><th>Role</th><th>Active</th><th>Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Projects -->
      <section id="page-projects" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-kanban me-2"></i>Projects</h2>
          <button id="btnAddProject" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Dự án</button>
        </div>
        <div id="projectFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>customer</th><th>Start</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- customers -->
      <section id="page-customers" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-people me-2"></i>customers</h2>
          <button id="btnAddcustomer" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Khách hàng</button>
        </div>
        <div id="customerFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>Tax</th><th>Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Contracts -->
      <section id="page-contracts" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-file-earmark-text me-2"></i>Contracts</h2>
          <button id="btnAddContract" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm HD</button>
        </div>
        <div id="contractFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Project</th><th>customer</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="contractTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Tasks -->
      <section id="page-tasks" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-check2-square me-2"></i>Tasks</h2>
          <button id="btnAddTask" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Thêm Task</button>
        </div>
        <div id="taskFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>ID</th><th>Name</th><th>Project</th><th>User</th><th>Totals</th><th>Done</th><th>Status</th><th>Deadline</th><th>Actions</th></tr></thead>
            <tbody id="taskTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Weekly Report -->
      <section id="page-weekly-report" class="d-none mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2><i class="bi bi-calendar-week me-2"></i>Weekly Report</h2>
          <button id="btnAddWeeklyReport" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Tạo Report</button>
        </div>
        <div id="weeklyReportFormWrap"></div>
        <div class="card card-shadow p-3">
          <table class="table table-hover">
            <thead><tr><th>Week</th><th>User</th><th>Tasks</th><th>Hours</th><th>Notes</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="weeklyReportTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- My Tasks Summary -->
      <section id="page-user-summary" class="d-none mb-4">
        <h2><i class="bi bi-person-check me-2"></i>My Tasks Summary</h2>
        <div class="row g-4 mt-3">
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksPending">0</h4><p>Pending</p></div></div>
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksInProgress">0</h4><p>In Progress</p></div></div>
          <div class="col-md-4"><div class="card card-shadow text-center p-3"><h4 id="myTasksCompleted">0</h4><p>Completed</p></div></div>
        </div>
        <div class="card card-shadow mt-3 p-3">
          <table class="table table-hover">
            <thead><tr><th>Task</th><th>Project</th><th>Deadline</th><th>Status</th><th>Progress</th></tr></thead>
            <tbody id="myTasksTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Project Summary -->
      <section id="page-project-summary" class="d-none mb-4">
        <h2><i class="bi bi-graph-up me-2"></i>Project Summary</h2>
        <div class="card card-shadow mt-3 p-3">
          <table class="table table-hover">
            <thead><tr><th>Project</th><th>customer</th><th>Total</th><th>Done</th><th>In Progress</th><th>Pending</th><th>Progress</th><th>Status</th></tr></thead>
            <tbody id="projectSummaryTbody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 0) Supabase Config
  const SUPABASE_URL = 'https://mfbdfhvqnxuhxwscdffv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mYmRmaHZxbnh1aHh3c2NkZmZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDE3MjIsImV4cCI6MjA2OTYxNzcyMn0.rV15XLuKNXR05uEXOunzCkPoPGAVNKrzMP4iffw-vxk';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) State & Helpers
    let currentUser = { email: null, role: 'user' };
    let users=[], projects=[], customers=[], contracts=[], tasks=[], weeklyReports=[];
    const pad=(n,w)=>String(n).padStart(w,'0');
    function getWeekNumber(d=new Date()){
      d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
      d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d-yearStart)/86400000)+1)/7);
    }
    const money=n=>(n||0).toLocaleString('vi-VN');
    // ID generators: generatecustomerId, generateProjectId, generateContractId, generateTaskId

    // 2) Auth Helpers
    function showAuth(msg=''){
      document.getElementById('authError').textContent=msg;
      document.getElementById('authOverlay').classList.remove('d-none');
    }
    function hideAuth(){
      document.getElementById('authOverlay').classList.add('d-none');
    }

    async function enforceAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){ showAuth(); return false; }
      const { data: prof, error } = await sb.from('user_profiles').select('role,active').eq('email',user.email).single();
      if(error || !prof || !prof.active){ showAuth('Email chưa active'); await sb.auth.signOut(); return false; }
      currentUser={ email:user.email, role:prof.role };
      document.getElementById('currentEmail').textContent=currentUser.email;
      hideAuth();
      return true;
    }

    // Google OAuth
    document.getElementById('btnGoogle').onclick = ()=>{
      sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo:location.href } });
    };
    document.getElementById('btnSignOut').onclick = async e=>{
      e.preventDefault(); await sb.auth.signOut(); location.reload();
    };
    sb.auth.onAuthStateChange(async(event)=>{
      if(event==='SIGNED_IN'){ if(await enforceAuth()){ await loadAll(); showSection('dashboard'); }}
      if(event==='SIGNED_OUT'){ showAuth(); }
    });

    // 3) Data Loading & Render
    async function loadData(){
      const [u,p,cus,con,ta,wr] = await Promise.all([
        sb.from('user_profiles').select('*'),
        sb.from('projects').select('*'),
        sb.from('customers').select('*'),
        sb.from('contracts').select('*'),
        sb.from('tasks').select('*'),
        sb.from('weekly_reports').select('*')
      ]);
      users=u.data; projects=p.data; customers=cus.data;
      contracts=con.data; tasks=ta.data; weeklyReports=wr.data;
      setKPIs(); updateUserTaskSummary(); renderProjectSummary(); renderAllTables();
    }
    async function loadAll(){ await loadData(); }

     /* 4) RENDER FUNCTIONS */
    function renderUsers() {
      const tbody = document.getElementById('userTbody');
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td>${user.active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.email}')">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.email}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function renderProjects() {
      const tbody = document.getElementById('projectTbody');
      tbody.innerHTML = projects.map(project => {
        const client = clients.find(c => c.id === project.customer_id);
        return `
          <tr>
            <td>${project.project_id}</td>
            <td>${project.project_name}</td>
            <td>${client ? client.name : 'N/A'}</td>
            <td>${project.start_date || 'N/A'}</td>
            <td>${project.end_date || 'N/A'}</td>
            <td><span class="status-badge ${project.status === 'active' ? 'status-in-progress' : project.status === 'completed' ? 'status-completed' : 'status-pending'}">${project.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editProject('${project.project_id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProject('${project.project_id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderClients() {
      const tbody = document.getElementById('clientTbody');
      tbody.innerHTML = clients.map(client => `
        <tr>
          <td>${client.id}</td>
          <td>${client.name}</td>
          <td>${client.contact_person || 'N/A'}</td>
          <td>${client.phone || 'N/A'}</td>
          <td>${client.email || 'N/A'}</td>
          <td>${client.tax_code || 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editClient('${client.id}')">Edit</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteClient('${client.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function renderContracts() {
      const tbody = document.getElementById('contractTbody');
      tbody.innerHTML = contracts.map(contract => {
        const project = projects.find(p => p.project_id === contract.project_id);
        const client = clients.find(c => c.id === contract.customer_id);
        return `
          <tr>
            <td>${contract.contract_id}</td>
            <td>${project ? project.project_name : 'N/A'}</td>
            <td>${client ? client.name : 'N/A'}</td>
            <td>${money(contract.value)}</td>
            <td><span class="status-badge ${contract.status === 'active' ? 'status-in-progress' : contract.status === 'completed' ? 'status-completed' : 'status-pending'}">${contract.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editContract('${contract.contract_id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteContract('${contract.contract_id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderTasks() {
      const tbody = document.getElementById('taskTbody');
      tbody.innerHTML = tasks.map(task => {
        const project = projects.find(p => p.project_id === task.project_id);
        const statusClass = task.status === 'pending' ? 'status-pending' : 
                           task.status === 'in_progress' ? 'status-in-progress' : 'status-completed';
        return `
          <tr>
            <td>${task.task_id}</td>
            <td>${task.task_name}</td>
            <td>${project ? project.project_name : 'N/A'}</td>
            <td>${task.assigned_user}</td>
            <td>${task.total_hours || 0}</td>
            <td>${task.completed_hours || 0}</td>
            <td><span class="status-badge ${statusClass}">${task.status}</span></td>
            <td>${task.deadline || 'N/A'}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editTask('${task.task_id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${task.task_id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderWeeklyReports() {
      const tbody = document.getElementById('weeklyReportTbody');
      tbody.innerHTML = weeklyReports.map(report => `
        <tr>
          <td>${report.week_year}</td>
          <td>${report.user_email}</td>
          <td>${report.completed_tasks || 0}</td>
          <td>${report.total_hours || 0}</td>
          <td>${report.suggestions || 'N/A'}</td>
          <td>${new Date(report.created_at).toLocaleDateString('vi-VN')}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewWeeklyReport('${report.id}')">View</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteWeeklyReport('${report.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    /* 5) FORM FUNCTIONS */
    function showUserForm(user = null) {
      const isEdit = !!user;
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">${isEdit ? 'Sửa' : 'Thêm'} User</h5>
            <form id="userForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" name="email" value="${user?.email || ''}" ${isEdit ? 'readonly' : ''} required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Role</label>
                  <select class="form-select" name="role" required>
                    <option value="user" ${user?.role === 'user' ? 'selected' : ''}>User</option>
                    <option value="manager" ${user?.role === 'manager' ? 'selected' : ''}>Manager</option>
                    <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="active" ${user?.active ? 'checked' : ''}>
                    <label class="form-check-label">Active</label>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">${isEdit ? 'Cập nhật' : 'Thêm'}</button>
                <button type="button" class="btn btn-secondary" onclick="hideUserForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('userFormWrap').innerHTML = formHtml;
      document.getElementById('userFormWrap').classList.remove('d-none');
      
      document.getElementById('userForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userData = {
          email: formData.get('email'),
          role: formData.get('role'),
          active: formData.has('active')
        };
        
        try {
          if (isEdit) {
            await sb.from('user_profiles').update(userData).eq('email', user.email);
          } else {
            await sb.from('user_profiles').insert(userData);
          }
          hideUserForm();
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function hideUserForm() {
      document.getElementById('userFormWrap').classList.add('d-none');
    }

    function showTaskForm(task = null) {
      const isEdit = !!task;
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">${isEdit ? 'Sửa' : 'Thêm'} Task</h5>
            <form id="taskForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Tên Task</label>
                  <input type="text" class="form-control" name="task_name" value="${task?.task_name || ''}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Dự án</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" name="project_search" id="projectSearch" 
                           value="${task ? projects.find(p => p.project_id === task.project_id)?.project_name || '' : ''}" 
                           placeholder="Tìm kiếm dự án..." autocomplete="off">
                    <input type="hidden" name="project_id" id="selectedProjectId" value="${task?.project_id || ''}">
                    <div id="projectSuggestions" class="suggestions d-none"></div>
                  </div>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Mô tả</label>
                  <textarea class="form-control" name="description" rows="3">${task?.description || ''}</textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Người thực hiện</label>
                  <select class="form-select" name="assigned_user" required>
                    <option value="">Chọn người thực hiện</option>
                    ${users.filter(u => u.active).map(u => 
                      `<option value="${u.email}" ${task?.assigned_user === u.email ? 'selected' : ''}>${u.email}</option>`
                    ).join('')}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tổng thời gian (giờ)</label>
                  <input type="number" class="form-control" name="total_hours" value="${task?.total_hours || ''}" min="0" step="0.5">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Thời gian đã thực hiện (giờ)</label>
                  <input type="number" class="form-control" name="completed_hours" value="${task?.completed_hours || 0}" min="0" step="0.5">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tình trạng</label>
                  <select class="form-select" name="status" required>
                    <option value="pending" ${task?.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in_progress" ${task?.status === 'in_progress' ? 'selected' : ''}>Đang thực hiện</option>
                    <option value="completed" ${task?.status === 'completed' ? 'selected' : ''}>Đã hoàn thành</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Deadline</label>
                  <input type="date" class="form-control" name="deadline" value="${task?.deadline || ''}">
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">${isEdit ? 'Cập nhật' : 'Thêm'}</button>
                <button type="button" class="btn btn-secondary" onclick="hideTaskForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('taskFormWrap').innerHTML = formHtml;
      document.getElementById('taskFormWrap').classList.remove('d-none');
      
      // Setup project autofill
      setupProjectAutofill();
      
      document.getElementById('taskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const taskData = {
          task_name: formData.get('task_name'),
          project_id: formData.get('project_id'),
          description: formData.get('description'),
          assigned_user: formData.get('assigned_user'),
          total_hours: parseFloat(formData.get('total_hours')) || 0,
          completed_hours: parseFloat(formData.get('completed_hours')) || 0,
          status: formData.get('status'),
          deadline: formData.get('deadline') || null
        };
        
        if (!taskData.project_id) {
          alert('Vui lòng chọn dự án');
          return;
        }
        
        try {
          if (isEdit) {
            await sb.from('tasks').update(taskData).eq('task_id', task.task_id);
          } else {
            taskData.task_id = generateTaskId();
            await sb.from('tasks').insert(taskData);
          }
          hideTaskForm();
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function setupProjectAutofill() {
      const searchInput = document.getElementById('projectSearch');
      const suggestionsDiv = document.getElementById('projectSuggestions');
      const hiddenInput = document.getElementById('selectedProjectId');
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length < 1) {
          suggestionsDiv.classList.add('d-none');
          return;
        }
        
        const matches = projects.filter(p => 
          p.project_name.toLowerCase().includes(query) || 
          p.project_id.toLowerCase().includes(query)
        );
        
        if (matches.length > 0) {
          suggestionsDiv.innerHTML = matches.map(p => 
            `<div class="suggestion-item" data-id="${p.project_id}" data-name="${p.project_name}">
              ${p.project_name} (${p.project_id})
            </div>`
          ).join('');
          suggestionsDiv.classList.remove('d-none');
        } else {
          suggestionsDiv.classList.add('d-none');
        }
      });
      
      suggestionsDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
          const projectId = e.target.dataset.id;
          const projectName = e.target.dataset.name;
          searchInput.value = projectName;
          hiddenInput.value = projectId;
          suggestionsDiv.classList.add('d-none');
        }
      });
      
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.classList.add('d-none');
        }
      });
    }

    function hideTaskForm() {
      document.getElementById('taskFormWrap').classList.add('d-none');
    }

    function showWeeklyReportForm() {
      const currentWeek = getWeekNumber();
      const currentYear = new Date().getFullYear();
      const weekYear = `${currentYear}-W${pad(currentWeek, 2)}`;
      
      // Get user's tasks for current week
      const userTasks = tasks.filter(t => t.assigned_user === currentUser.email);
      
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">Tạo báo cáo tuần ${weekYear}</h5>
            <form id="weeklyReportForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Tuần</label>
                  <input type="text" class="form-control" name="week_year" value="${weekYear}" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Người báo cáo</label>
                  <input type="text" class="form-control" name="user_email" value="${currentUser.email}" readonly>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Tasks đã hoàn thành trong tuần</label>
                  <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                    ${userTasks.map(task => {
                      const project = projects.find(p => p.project_id === task.project_id);
                      return `
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="completed_task_ids" value="${task.task_id}" id="task_${task.task_id}">
                          <label class="form-check-label" for="task_${task.task_id}">
                            ${task.task_name} - ${project ? project.project_name : 'N/A'}
                          </label>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tổng thời gian thực hiện (giờ)</label>
                  <input type="number" class="form-control" name="total_hours" min="0" step="0.5" required>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Đề xuất kiến nghị</label>
                  <textarea class="form-control" name="suggestions" rows="4" placeholder="Nhập đề xuất, kiến nghị cho tuần tiếp theo..."></textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">Tạo báo cáo</button>
                <button type="button" class="btn btn-secondary" onclick="hideWeeklyReportForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('weeklyReportFormWrap').innerHTML = formHtml;
      document.getElementById('weeklyReportFormWrap').classList.remove('d-none');
      
      document.getElementById('weeklyReportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const completedTaskIds = formData.getAll('completed_task_ids');
        
        const reportData = {
          week_year: formData.get('week_year'),
          user_email: formData.get('user_email'),
          completed_tasks: completedTaskIds.length,
          completed_task_ids: completedTaskIds,
          total_hours: parseFloat(formData.get('total_hours')),
          suggestions: formData.get('suggestions'),
          created_at: new Date().toISOString()
        };
        
        try {
          await sb.from('weekly_reports').insert(reportData);
          hideWeeklyReportForm();
          loadData();
          alert('Báo cáo đã được tạo thành công!');
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function hideWeeklyReportForm() {
      document.getElementById('weeklyReportFormWrap').classList.add('d-none');
    }

    /* 6) CRUD FUNCTIONS */
    async function editUser(email) {
      const user = users.find(u => u.email === email);
      if (user) showUserForm(user);
    }

    async function deleteUser(email) {
      if (confirm('Bạn có chắc muốn xóa user này?')) {
        try {
          await sb.from('user_profiles').delete().eq('email', email);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    async function editTask(taskId) {
      const task = tasks.find(t => t.task_id === taskId);
      if (task) showTaskForm(task);
    }

    async function deleteTask(taskId) {
      if (confirm('Bạn có chắc muốn xóa task này?')) {
        try {
          await sb.from('tasks').delete().eq('task_id', taskId);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    async function deleteWeeklyReport(reportId) {
      if (confirm('Bạn có chắc muốn xóa báo cáo này?')) {
        try {
          await sb.from('weekly_reports').delete().eq('id', reportId);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    function viewWeeklyReport(reportId) {
      const report = weeklyReports.find(r => r.id === reportId);
      if (report) {
        const completedTaskNames = report.completed_task_ids?.map(taskId => {
          const task = tasks.find(t => t.task_id === taskId);
          return task ? task.task_name : taskId;
        }).join(', ') || 'Không có';
        
        alert(`Báo cáo tuần ${report.week_year}
Người báo cáo: ${report.user_email}
Tasks hoàn thành: ${completedTaskNames}
Tổng thời gian: ${report.total_hours} giờ
Đề xuất: ${report.suggestions || 'Không có'}`);
      }
    }

    /* CRUD Functions for Projects */
    function showProjectForm(project = null) {
      const isEdit = !!project;
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">${isEdit ? 'Sửa' : 'Thêm'} Dự án</h5>
            <form id="projectForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Tên dự án</label>
                  <input type="text" class="form-control" name="project_name" value="${project?.project_name || ''}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Khách hàng</label>
                  <select class="form-select" name="customer_id" required>
                    <option value="">Chọn khách hàng</option>
                    ${clients.map(c => 
                      `<option value="${c.id}" ${project?.customer_id === c.id ? 'selected' : ''}>${c.name}</option>`
                    ).join('')}
                  </select>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Mô tả</label>
                  <textarea class="form-control" name="description" rows="3">${project?.description || ''}</textarea>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Ngày bắt đầu</label>
                  <input type="date" class="form-control" name="start_date" value="${project?.start_date || ''}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Ngày kết thúc</label>
                  <input type="date" class="form-control" name="end_date" value="${project?.end_date || ''}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Trạng thái</label>
                  <select class="form-select" name="status" required>
                    <option value="active" ${project?.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="on_hold" ${project?.status === 'on_hold' ? 'selected' : ''}>On Hold</option>
                    <option value="completed" ${project?.status === 'completed' ? 'selected' : ''}>Completed</option>
                  </select>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">${isEdit ? 'Cập nhật' : 'Thêm'}</button>
                <button type="button" class="btn btn-secondary" onclick="hideProjectForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('projectFormWrap').innerHTML = formHtml;
      document.getElementById('projectFormWrap').classList.remove('d-none');
      
      document.getElementById('projectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const projectData = {
          project_name: formData.get('project_name'),
          customer_id: formData.get('customer_id'),
          description: formData.get('description'),
          start_date: formData.get('start_date') || null,
          end_date: formData.get('end_date') || null,
          status: formData.get('status')
        };
        
        try {
          if (isEdit) {
            await sb.from('projects').update(projectData).eq('project_id', project.project_id);
          } else {
            projectData.project_id = generateProjectId();
            await sb.from('projects').insert(projectData);
          }
          hideProjectForm();
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function hideProjectForm() {
      document.getElementById('projectFormWrap').classList.add('d-none');
    }

    function editProject(projectId) {
      const project = projects.find(p => p.project_id === projectId);
      if (project) showProjectForm(project);
    }

    async function deleteProject(projectId) {
      if (confirm('Bạn có chắc muốn xóa dự án này?')) {
        try {
          await sb.from('projects').delete().eq('project_id', projectId);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    /* CRUD Functions for Clients */
    function showClientForm(client = null) {
      const isEdit = !!client;
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">${isEdit ? 'Sửa' : 'Thêm'} Khách hàng</h5>
            <form id="clientForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Tên khách hàng</label>
                  <input type="text" class="form-control" name="name" value="${client?.name || ''}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Người liên hệ</label>
                  <input type="text" class="form-control" name="contact_person" value="${client?.contact_person || ''}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Số điện thoại</label>
                  <input type="tel" class="form-control" name="phone" value="${client?.phone || ''}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" name="email" value="${client?.email || ''}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Mã số thuế</label>
                  <input type="text" class="form-control" name="tax_code" value="${client?.tax_code || ''}">
                </div>
                <div class="col-md-12">
                  <label class="form-label">Địa chỉ</label>
                  <textarea class="form-control" name="address" rows="2">${client?.address || ''}</textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">${isEdit ? 'Cập nhật' : 'Thêm'}</button>
                <button type="button" class="btn btn-secondary" onclick="hideClientForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('clientFormWrap').innerHTML = formHtml;
      document.getElementById('clientFormWrap').classList.remove('d-none');
      
      document.getElementById('clientForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const clientData = {
          name: formData.get('name'),
          contact_person: formData.get('contact_person'),
          phone: formData.get('phone'),
          email: formData.get('email'),
          tax_code: formData.get('tax_code'),
          address: formData.get('address')
        };
        
        try {
          if (isEdit) {
            await sb.from('customers').update(clientData).eq('id', client.id);
          } else {
            clientData.id = generateClientId();
            await sb.from('customers').insert(clientData);
          }
          hideClientForm();
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function hideClientForm() {
      document.getElementById('clientFormWrap').classList.add('d-none');
    }

    function editClient(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (client) showClientForm(client);
    }

    async function deleteClient(clientId) {
      if (confirm('Bạn có chắc muốn xóa khách hàng này?')) {
        try {
          await sb.from('customers').delete().eq('id', clientId);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    /* CRUD Functions for Contracts */
    function showContractForm(contract = null) {
      const isEdit = !!contract;
      const formHtml = `
        <div class="card card-shadow mb-4">
          <div class="card-body">
            <h5 class="card-title">${isEdit ? 'Sửa' : 'Thêm'} Hợp đồng</h5>
            <form id="contractForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Dự án</label>
                  <select class="form-select" name="project_id" required>
                    <option value="">Chọn dự án</option>
                    ${projects.map(p => 
                      `<option value="${p.project_id}" ${contract?.project_id === p.project_id ? 'selected' : ''}>${p.project_name}</option>`
                    ).join('')}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Khách hàng</label>
                  <select class="form-select" name="customer_id" required>
                    <option value="">Chọn khách hàng</option>
                    ${clients.map(c => 
                      `<option value="${c.id}" ${contract?.customer_id === c.id ? 'selected' : ''}>${c.name}</option>`
                    ).join('')}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Giá trị hợp đồng</label>
                  <input type="number" class="form-control" name="value" value="${contract?.value || ''}" min="0" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Trạng thái</label>
                  <select class="form-select" name="status" required>
                    <option value="draft" ${contract?.status === 'draft' ? 'selected' : ''}>Draft</option>
                    <option value="active" ${contract?.status === 'active' ? 'selected' : ''}>Active</option>
                    <option value="completed" ${contract?.status === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="cancelled" ${contract?.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ngày ký</label>
                  <input type="date" class="form-control" name="signed_date" value="${contract?.signed_date || ''}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ngày hết hạn</label>
                  <input type="date" class="form-control" name="expiry_date" value="${contract?.expiry_date || ''}">
                </div>
                <div class="col-md-12">
                  <label class="form-label">Ghi chú</label>
                  <textarea class="form-control" name="notes" rows="3">${contract?.notes || ''}</textarea>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">${isEdit ? 'Cập nhật' : 'Thêm'}</button>
                <button type="button" class="btn btn-secondary" onclick="hideContractForm()">Hủy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('contractFormWrap').innerHTML = formHtml;
      document.getElementById('contractFormWrap').classList.remove('d-none');
      
      document.getElementById('contractForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const contractData = {
          project_id: formData.get('project_id'),
          customer_id: formData.get('customer_id'),
          value: parseFloat(formData.get('value')),
          status: formData.get('status'),
          signed_date: formData.get('signed_date') || null,
          expiry_date: formData.get('expiry_date') || null,
          notes: formData.get('notes')
        };
        
        try {
          if (isEdit) {
            await sb.from('contracts').update(contractData).eq('contract_id', contract.contract_id);
          } else {
            contractData.contract_id = generateContractId();
            await sb.from('contracts').insert(contractData);
          }
          hideContractForm();
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      });
    }

    function hideContractForm() {
      document.getElementById('contractFormWrap').classList.add('d-none');
    }

    function editContract(contractId) {
      const contract = contracts.find(c => c.contract_id === contractId);
      if (contract) showContractForm(contract);
    }

    async function deleteContract(contractId) {
      if (confirm('Bạn có chắc muốn xóa hợp đồng này?')) {
        try {
          await sb.from('contracts').delete().eq('contract_id', contractId);
          loadData();
        } catch (error) {
          alert('Lỗi: ' + error.message);
        }
      }
    }

    /* 7) EVENT LISTENERS */
    document.addEventListener('DOMContentLoaded', async () => {
      // Auth check
      if (await checkAuth()) {
        await loadData();
      }

      // Navigation
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const page = e.target.closest('a').dataset.page;
          showSection(page);
          
          // Update user summary when viewing that page
          if (page === 'user-summary') {
            updateUserTaskSummary();
          }
          
          // Update project summary when viewing that page
          if (page === 'project-summary') {
            renderProjectSummary();
          }
        });
      });

      // Auth buttons
      document.getElementById('btnGoogle').addEventListener('click', signInWithGoogle);
      document.getElementById('btnSignOut').addEventListener('click', signOut);

      // Add buttons
      document.getElementById('btnAddUser').addEventListener('click', () => showUserForm());
      document.getElementById('btnAddTask').addEventListener('click', () => showTaskForm());
      document.getElementById('btnAddWeeklyReport').addEventListener('click', showWeeklyReportForm);
      document.getElementById('btnAddProject').addEventListener('click', () => showProjectForm());
      document.getElementById('btnAddClient').addEventListener('click', () => showClientForm());
      document.getElementById('btnAddContract').addEventListener('click', () => showContractForm());

      // Auth state change listener
      sb.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
          checkAuth().then(success => {
            if (success) loadData();
          });
        } else if (event === 'SIGNED_OUT') {
          location.reload();
        }

    // 8) Navigation
    function showSection(page){
      document.querySelectorAll('[id^="page-"]').forEach(s=>s.classList.add('d-none'));
      document.getElementById(`page-${page}`).classList.remove('d-none');
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.classList.toggle('active', a.dataset.page===page));
    }

    // 9) Init
    document.addEventListener('DOMContentLoaded', async()=>{
      if(await enforceAuth()){ await loadAll(); showSection('dashboard'); }
      document.querySelectorAll('#sidebarNav .nav-link').forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); showSection(a.dataset.page); }));
      // Add button listeners
      document.getElementById('btnAddUser').onclick = ()=>showUserForm();
      document.getElementById('btnAddProject').onclick = ()=>showProjectForm();
      document.getElementById('btnAddcustomer').onclick = ()=>showcustomerForm();
      document.getElementById('btnAddContract').onclick = ()=>showContractForm();
      document.getElementById('btnAddTask').onclick = ()=>showTaskForm();
      document.getElementById('btnAddWeeklyReport').onclick = ()=>showWeeklyReportForm();
    });
  </script>
</body>
</html>
