<!doctype html>
<html lang="vi">
<head>
  <!-- =========================================================
       VSEC CRM Minimal • Single HTML (Trimmed 2025-08-01)
       Kept modules:
       • Google OAuth + whitelist (user_profiles.active = true)
       • Customers (thêm/sửa/xoá)
       • Projects  (thêm/sửa/xoá) – liên kết Customer
       • Users     (quản lý user + active email)
       ========================================================= -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VSEC • CRM Minimal</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    html,body{height:100%;background:#f8f9fa}
    .sidebar{width:260px;min-height:100vh;position:sticky;top:0;border-right:1px solid #e9ecef;background:#fff}
    .sidebar .nav-link{border-radius:.5rem;color:#334155}
    .sidebar .nav-link.active,.sidebar .nav-link:hover{background:#e7f1ff;color:#0d6efd}
    .content-wrap{margin-left:0}
    @media(min-width:992px){.content-wrap{margin-left:260px}.sidebar{position:fixed}}
    .card-shadow{box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid #eef2f7;border-radius:1rem}
    .suggestions{position:absolute;z-index:1050;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;max-height:260px;overflow-y:auto;width:100%;box-shadow:0 10px 22px rgba(0,0,0,.08)}
    .suggestion-item{padding:.5rem .75rem;cursor:pointer}
    .suggestion-item:hover{background:#f5f7fb}
    .auth-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.55);backdrop-filter:blur(2px);z-index:3000}
    .auth-card{width:420px;border-radius:1rem;box-shadow:0 20px 40px rgba(0,0,0,.2)}
  </style>
</head>
<body>

  <!-- ===== AUTH OVERLAY ===== -->
  <div id="authOverlay" class="auth-overlay d-none">
    <div class="card auth-card">
      <div class="card-body text-center p-4">
        <div class="mb-3"><i class="bi bi-shield-lock" style="font-size:2.5rem;"></i></div>
        <h5 class="fw-bold mb-2">Đăng nhập VSEC CRM</h5>
        <p class="text-muted small mb-4">Chỉ chấp nhận email nằm trong bảng <code>user_profiles</code> và <code>active = true</code>.</p>
        <button id="btnGoogle" class="btn btn-dark w-100 mb-2"><i class="bi bi-google me-2"></i>Đăng nhập bằng Google</button>
        <div id="authError" class="text-danger small mt-2"></div>
      </div>
    </div>
  </div>

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar p-3">
    <a class="d-flex align-items-center mb-3 text-decoration-none" href="#">
      <span class="fs-5 fw-bold"><i class="bi bi-kanban me-2"></i>VSEC CRM</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column gap-1" id="sidebarNav">
      <li class="nav-item"><a class="nav-link active" data-page="customers"><i class="bi bi-people me-2"></i>Customers</a></li>
      <li class="nav-item"><a class="nav-link" data-page="projects"><i class="bi bi-kanban me-2"></i>Projects</a></li>
      <li class="nav-item"><a class="nav-link" data-page="users" id="navUsers"><i class="bi bi-person-gear me-2"></i>Users</a></li>
    </ul>
    <hr>
    <div class="dropdown">
      <a class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" href="#">
        <img src="https://ui-avatars.com/api/?name=CRM&background=0D6EFD&color=fff" alt="avatar" width="32" height="32" class="rounded-circle me-2">
        <strong id="currentEmail">guest@local</strong>
      </a>
      <ul class="dropdown-menu shadow">
        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
      </ul>
    </div>
  </aside>

  <!-- ================= MAIN ================= -->
  <main class="content-wrap">
    <div class="container-fluid py-4">

      <!-- CUSTOMERS -->
      <section id="page-customers" class="section-anchor">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Customers</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddCustomer"><i class="bi bi-plus-lg me-1"></i>Thêm khách hàng</button></div>
        </div>
        <div id="customerFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Contact</th><th>Phone</th><th>Email</th><th>Tax</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="customerTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- PROJECTS -->
      <section id="page-projects" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-kanban me-2"></i>Projects</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddProject"><i class="bi bi-plus-lg me-1"></i>Thêm dự án</button></div>
        </div>
        <div id="projectFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>ID</th><th>Tên dự án</th><th>Khách hàng</th><th>Start</th><th>End</th><th>Status</th><th style="width:120px;">Actions</th></tr></thead>
            <tbody id="projectTbody"></tbody>
          </table>
        </div></div>
      </section>

      <!-- USERS -->
      <section id="page-users" class="section-anchor d-none">
        <div class="d-flex align-items-center mb-4">
          <h1 class="h3 mb-0"><i class="bi bi-person-gear me-2"></i>Users</h1>
          <div class="ms-auto"><button class="btn btn-primary" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Thêm user</button></div>
        </div>
        <div id="userFormWrap" class="d-none"></div>
        <div class="card card-shadow"><div class="card-body table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light"><tr><th>Email</th><th>Role</th><th>Active</th><th style="width:140px;">Actions</th></tr></thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div></div>
      </section>

    </div>
  </main>

  <!-- ================= SCRIPTS ================= -->
  <script>
    /* 0) SUPABASE CONFIG */
    const SUPABASE_URL = 'https://jhybbyzpgyfxtfpnuhqt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoeWJieXpwZ3lmeHRmcG51aHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTg2MTgsImV4cCI6MjA2OTU5NDYxOH0.d0jrlFshaX-y_HSuVL_LOo0JsPvD1qqm4ceK1styUaQ';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* 1) STATE */
    let currentUser = { email: null, role: 'user' };
    let customers = [], projects = [], users = [];

    /* Helpers */
    const pad = (n,w)=> (n+'').padStart(w,'0');
    function generateCustomerId(){ const used=customers.map(c=>parseInt((c.id||'').slice(1),10)).filter(Number.isFinite); for(let i=1;i<10000;i++) if(!used.includes(i)) return 'C'+pad(i,4); }
    function generateProjectId(){ const y=new Date().getFullYear().toString().slice(-2); const used=projects.filter(p=>(p.project_id||'').startsWith('P_'+y)).map(p=>parseInt(p.project_id.slice(4),10)).filter(Number.isFinite); for(let i=1;i<1000;i++) if(!used.includes(i)) return 'P_'+y+pad(i,3); }
    const money=n=> (n||0).toLocaleString('vi-VN');

    /* 2) LOAD DATA */
    async function loadAll(){ const rs = await Promise.all([
        sb.from('customers').select('*').order('id'),
        sb.from('projects').select('*').order('project_id'),
        sb.from('user_profiles').select('*')
      ]);
      customers = rs[0].data||[];
      projects  = rs[1].data||[];
      users     = rs[2].data||[];
    }

    /* 3) RENDERERS */
    function renderCustomers(){ const tbody=document.getElementById('customerTbody'); tbody.innerHTML=customers.map(c=>`
      <tr>
        <td>${c.id}</td><td class="text-start">${c.name||''}</td><td>${c.contact_person||''}</td><td>${c.phone||''}</td><td>${c.email||''}</td><td>${c.tax_code||''}</td>
        <td><button class="btn btn-sm btn-outline-secondary me-1" onclick="openCustomerForm('${
